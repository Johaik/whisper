---
- name: Check Windows deployment status
  hosts: windows
  gather_facts: no

  vars:
    win_app_dir: "C:\\app"

  tasks:
    - name: Gather comprehensive status
      ansible.windows.win_powershell:
        script: |
          Write-Output "╔══════════════════════════════════════════════════════════════╗"
          Write-Output "║              WHISPER DEPLOYMENT STATUS                       ║"
          Write-Output "╚══════════════════════════════════════════════════════════════╝"
          Write-Output ""
          
          # Container Status
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ CONTAINERS                                                  │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}{% endraw %}"
          Write-Output ""
          
          # Queue Status
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ PROCESSING QUEUE                                            │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          try {
            $q = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/queue/status" -TimeoutSec 5
            Write-Output ("  Waiting (Queued) : {0}" -f $q.queued)
            Write-Output ("  Active (Moving)  : {0}" -f $q.processing)
            Write-Output ("  Total Pending    : {0}" -f ($q.queued + $q.processing))
            Write-Output ("  Accept more      : {0} (threshold: {1})" -f $q.can_accept_more, $q.threshold)
          } catch {
            Write-Output "  API not available"
          }
          Write-Output ""
          
          # Recordings Summary (query database directly via docker)
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ DATABASE RECORDINGS                                         │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          try {
            # Map statuses to more readable labels
            $statusMap = @{
              "discovered" = "Discovered"
              "queued"     = "Queued"
              "processing" = "Processing"
              "done"       = "Completed"
              "failed"     = "Failed"
              "skipped"    = "Skipped"
            }
            
            $query = "SELECT status, COUNT(*) as count FROM recordings GROUP BY status ORDER BY status;"
            $result = docker exec whisper-postgres psql -U whisper -d whisper -t -c "$query" 2>$null
            
            if ($result) {
              $lines = $result.Trim().Split("`n")
              foreach ($line in $lines) {
                if ($line.Contains("|")) {
                  $parts = $line.Split("|")
                  $rawStatus = $parts[0].Trim()
                  $count = $parts[1].Trim()
                  $label = if ($statusMap.ContainsKey($rawStatus)) { $statusMap[$rawStatus] } else { $rawStatus }
                  Write-Output ("  {0,-15}: {1}" -f $label, $count)
                }
              }
            } else {
              Write-Output "  No recordings found in database"
            }
            
            $total = docker exec whisper-postgres psql -U whisper -d whisper -t -c "SELECT COUNT(*) FROM recordings;" 2>$null
            Write-Output "  ───────────────────────────────"
            Write-Output ("  Total          : {0}" -f $total.Trim())
          } catch {
            Write-Output "  Database not available"
          }
          Write-Output ""
          
          # Google Drive Sync Status
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ GOOGLE DRIVE SYNC                                           │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          $uniqueCopiedCount = 0
          if (Test-Path "{{ win_app_dir }}\copied-files.txt") {
            $uniqueCopiedCount = (Get-Content "{{ win_app_dir }}\copied-files.txt" | Select-Object -Unique | Measure-Object).Count
          }
          $callsCount = (Get-ChildItem "{{ win_app_dir }}\Calls" -File 2>$null | Measure-Object).Count
          
          $gdriveCount = 0
          if (Test-Path "H:\My Drive\calls") {
            $gdriveCount = (Get-ChildItem "H:\My Drive\calls" -File -Include "*.mp3","*.wav","*.m4a","*.ogg","*.flac","*.aac" -Recurse | Measure-Object).Count
          }
          
          Write-Output ("  Source (G: Drive) : {0}" -f $gdriveCount)
          Write-Output ("  Synced (Log)      : {0}" -f $uniqueCopiedCount)
          Write-Output ("  Local (Calls)     : {0}" -f $callsCount)
          
          $remaining = $gdriveCount - $uniqueCopiedCount
          if ($remaining -gt 0) {
            Write-Output ("  Remaining         : {0}" -f $remaining)
          } elseif ($gdriveCount -gt 0) {
            Write-Output "  Status            : Fully Synced"
          } else {
            Write-Output "  Status            : G: drive not reachable"
          }
          Write-Output ""
          
          # Scheduled Task Status
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ SCHEDULED TASK                                              │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          $task = Get-ScheduledTask -TaskName "WhisperBatchSync" -ErrorAction SilentlyContinue
          if ($task) {
            $info = Get-ScheduledTaskInfo -TaskName "WhisperBatchSync"
            Write-Output "  Status:    $($task.State)"
            Write-Output "  Last run:  $($info.LastRunTime)"
            Write-Output "  Next run:  $($info.NextRunTime)"
          } else {
            Write-Output "  Task not configured"
          }
          Write-Output ""
          
          # Celery Task Metrics (same as Grafana)
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ CELERY TASK METRICS (Flower)                                │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          try {
            $metrics = Invoke-WebRequest -Uri "http://localhost:5555/metrics" -UseBasicParsing -TimeoutSec 5
            $content = $metrics.Content
            
            $received = 0
            $succeeded = 0
            $failed = 0
            
            $content -split "`n" | ForEach-Object {
              if ($_ -match 'flower_events_total\{[^}]*type="task-received"[^}]*\}\s+(\d+)') {
                $received += [int]$matches[1]
              }
              if ($_ -match 'flower_events_total\{[^}]*type="task-succeeded"[^}]*\}\s+(\d+)') {
                $succeeded += [int]$matches[1]
              }
              if ($_ -match 'flower_events_total\{[^}]*type="task-failed"[^}]*\}\s+(\d+)') {
                $failed += [int]$matches[1]
              }
            }
            
            $completed = $succeeded + $failed
            $notCompleted = $received - $completed
            
            Write-Output "  Received:   $received (cumulative)"
            Write-Output "  Succeeded:  $succeeded (cumulative)"
            Write-Output "  Failed:     $failed (cumulative)"
            Write-Output "  Not done:   $notCompleted (queued + in progress; see API for active tasks)"
          } catch {
            Write-Output "  Flower metrics not available"
          }
          Write-Output ""
          
          # Recent Worker Activity
          Write-Output "┌─────────────────────────────────────────────────────────────┐"
          Write-Output "│ RECENT WORKER ACTIVITY (last 15 lines)                      │"
          Write-Output "└─────────────────────────────────────────────────────────────┘"
          $workerLogs = docker logs whisper-worker --tail=15 2>&1
          if ($workerLogs) {
            $workerLogs | ForEach-Object { Write-Output "  $_" }
          } else {
            Write-Output "  (no output)"
          }
          Write-Output ""
      register: status_output

    - name: Display status
      ansible.builtin.debug:
        msg: "{{ status_output.output }}"
